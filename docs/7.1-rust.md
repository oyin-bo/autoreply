# Rust Bluesky MCP Server

Model Context Protocol server for Bluesky profile and post search functionality.

## Overview

Implements two MCP tools:
- `profile(account)` - Retrieve user profile information
- `search(account, query)` - Search posts within a user's repository

## API Specification

### Tool: profile

**Parameters:**
```json
{
  "account": "string"  // Handle (alice.bsky.social) or DID (did:plc:...)
}
```

**Returns:** Markdown-formatted profile information

### Tool: search

**Parameters:**
```json
{
  "account": "string", // Handle or DID
  "query": "string"    // Search terms (case-insensitive)
}
```

**Returns:** Markdown-formatted list of matching posts

### Input Validation

- **account**: Must be valid handle format `name.host.tld` or DID format `did:plc:[a-z2-7]{24}`
- **query**: Plain text, normalized via Unicode NFKC, trimmed whitespace
- Maximum query length: 500 characters

### MCP Protocol Format

**Request:**
```json
{"jsonrpc": "2.0", "id": 1, "method": "tools/call", "params": {"name": "profile", "arguments": {"account": "alice.bsky.social"}}}
```

**Success Response:**
```json
{"jsonrpc": "2.0", "id": 1, "result": {"content": [{"type": "text", "text": "# Profile\n\n..."}]}}
```

**Error Response:**
```json
{"jsonrpc": "2.0", "id": 1, "error": {"code": "did_resolve_failed", "message": "Unable to resolve handle to DID"}}
```

## Technical Implementation

### Core Components

#### 1. DID Resolution Module

**Handle Resolution:**
- Resolve via XRPC: `https://{hostname}/xrpc/com.atproto.identity.resolveHandle?handle={handle}`


#### 2. CAR Cache System

**Cache Directory Structure:**
```
{cache_dir}/
├── repos/
│   ├── did-plc-abc123.car
│   └── did-plc-xyz789.car
└── metadata/
    ├── did-plc-abc123.json  // Last-Modified, ETag, size
    └── did-plc-xyz789.json
```

**Cache Location:**
- Linux/macOS: `$XDG_CACHE_HOME/bluesky-mcp` or `$HOME/.cache/bluesky-mcp`
- Windows: `%LOCALAPPDATA%\bluesky-mcp`

**Cache Validation:**
- Store HTTP Last-Modified and ETag in metadata files
- TTL: 24 hours for repos, 1 hour for profiles
- Validate file integrity via Content-Length

#### 3. CAR Processing Pipeline

**Repository Fetch:**
- Primary endpoint: `https://bsky.social/xrpc/com.atproto.sync.getRepo?did={did}`
- Stream download with progress tracking
- Atomic writes: `.tmp` suffix during download, rename on completion
- Concurrent download protection via file locking

**Record Extraction:**
```rust
struct ProfileRecord {
    display_name: Option<String>,
    description: Option<String>,
    avatar: Option<String>,
    banner: Option<String>,
    created_at: String,
}

struct PostRecord {
    uri: String,
    cid: String,
    text: String,
    created_at: String,
    embeds: Vec<Embed>,
    facets: Vec<Facet>,
}
```

**Target Collections:**
- `app.bsky.actor.profile` - Profile information
- `app.bsky.feed.post` - Post content

#### 4. Search Implementation

**Text Matching:**
- Normalize query and post text using Unicode NFKC
- Case-insensitive substring matching
- Search in: post text, image alt-text, embed titles/descriptions
- Highlight matches with `**bold**` markdown

**Search Scope:**
- Post text content
- Image alt-text in embeds
- External link titles and descriptions
- Reply/quote text (if included in record)

### Error Handling

**Error Codes:**
- `invalid_input` - Malformed account or query parameters
- `did_resolve_failed` - Cannot resolve handle to DID  
- `repo_fetch_failed` - Unable to download CAR file
- `repo_parse_failed` - CAR file corrupted or invalid
- `not_found` - No profile or matching posts found
- `timeout` - Operation exceeded time limits
- `cache_error` - File system operations failed

**Timeout Configuration:**
- DID resolution: 10 seconds
- CAR download: 60 seconds  
- CAR parsing: 30 seconds
- Total request timeout: 120 seconds

### Output Formatting

#### Profile Tool Output

```markdown
# @{handle} ({did})

**Display Name:** {displayName}

**Description:**
{description}

**Avatar:** ![Avatar]({avatarUrl})

**Stats:**
- Created: {createdAt}
- PDS: {pdsEndpoint}

**Verified Links:**
- {domain}: [Link]({url})

<details>
<summary>Raw Profile Data</summary>

```json
{profileRecord}
```
</details>
```

#### Search Tool Output

```markdown
# Search Results for "{query}" in @{handle}

## Post 1
**URI:** [at://{repo}/app.bsky.feed.post/{rkey}]({postUrl})  
**Created:** {timestamp}

{postText with **highlighted** matches}

**Links:**
- [External Link]({url})

**Images:**
- ![Alt text]({imageUrl})

---

## Post 2
...
```

## Dependencies

**Required Crates:**
- `tokio` - Async runtime
- `reqwest` - HTTP client with streaming
- `serde_json` - JSON serialization
- `serde_cbor` - CBOR decoding for IPLD
- `ipld-core` - IPLD data structures
- `unicode-normalization` - Text normalization
- `regex` - Text matching
- `clap` - CLI argument parsing (if needed)
- `anyhow` - Error handling
- `tracing` - Logging

**Optional Crates:**
- `car-rs` or `ipld-car` - CAR file parsing
- `aho-corasick` - Fast multi-pattern search
- `fs2` - File locking

## File Structure

```
src/
├── main.rs           // MCP server entry point
├── mcp.rs            // MCP protocol handling  
├── tools/
│   ├── mod.rs
│   ├── profile.rs    // Profile tool implementation
│   └── search.rs     // Search tool implementation
├── bluesky/
│   ├── mod.rs
│   ├── did.rs        // DID resolution
│   ├── car.rs        // CAR file operations
│   └── records.rs    // AT Protocol record types
├── cache.rs          // Cache management
└── error.rs          // Error types and handling
```

## Implementation Checklist

### Phase 1: Core Infrastructure
- [ ] MCP server scaffold with JSON-RPC handling
- [ ] DID resolution (handle → DID)
- [ ] Basic CAR file download and caching
- [ ] CBOR/IPLD record parsing

### Phase 2: Profile Tool
- [ ] Profile record extraction from CAR
- [ ] Markdown formatting for profiles
- [ ] Error handling and validation

### Phase 3: Search Tool  
- [ ] Post record extraction and indexing
- [ ] Text search with highlighting
- [ ] Result pagination and formatting

### Phase 4: Polish
- [ ] Comprehensive error handling
- [ ] Cache optimization and cleanup
- [ ] Performance testing and optimization
- [ ] Documentation and examples

